<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Analysis</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: radial-gradient(circle at top left, rgba(37, 99, 235, 0.1), transparent 55%),
             radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.1), transparent 60%),
             #f4f6fb;
      --surface: rgba(255, 255, 255, 0.95);
      --surface-soft: rgba(248, 250, 255, 0.82);
      --border: rgba(15, 23, 42, 0.08);
      --border-strong: rgba(15, 23, 42, 0.16);
      --text: #0f172a;
      --muted: #475467;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --accent: #22c55e;
      --danger: #dc2626;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      padding: clamp(24px, 5vw, 48px);
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .shell {
      width: min(1080px, 100%);
      display: grid;
      gap: clamp(20px, 3vw, 32px);
    }
    .header {
      background: var(--surface);
      border-radius: 28px;
      border: 1px solid var(--border);
      box-shadow: 0 26px 52px rgba(15, 23, 42, 0.14);
      padding: clamp(28px, 4vw, 42px);
      display: grid;
      gap: 16px;
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.45px;
      text-transform: uppercase;
      font-size: 14px;
    }
    .brand::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      box-shadow: 0 0 10px rgba(37, 99, 235, 0.4);
    }
    h1 {
      margin: 0;
      font-size: clamp(32px, 5vw, 40px);
      letter-spacing: -0.6px;
    }
    .subhead {
      margin: 0;
      color: var(--muted);
      font-size: 17px;
      max-width: 60ch;
    }
    .controls {
      background: var(--surface);
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
      padding: clamp(26px, 3vw, 34px);
      display: grid;
      gap: clamp(18px, 2.5vw, 26px);
    }
    .section-title {
      margin: 0;
      font-weight: 600;
      font-size: 18px;
    }
    .date-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .date-chip {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: rgba(255,255,255,0.9);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .date-chip.active {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: #fff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
      border-color: transparent;
    }
    .date-chip:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: flex-end;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    select {
      border-radius: 14px;
      border: 1px solid var(--border-strong);
      padding: 12px 14px;
      font-size: 15px;
      background: var(--surface-soft);
      color: var(--text);
      min-width: 220px;
    }
    .export-btn {
      border: none;
      border-radius: 14px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #15803d, #22c55e);
      color: #fff;
      box-shadow: 0 14px 28px rgba(21, 128, 61, 0.28);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }
    .export-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }
    .upload-box {
      border: 1px dashed rgba(37, 99, 235, 0.26);
      border-radius: 18px;
      background: rgba(37, 99, 235, 0.06);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .upload-box input {
      font-size: 13px;
    }
    .results {
      display: grid;
      gap: clamp(18px, 2.5vw, 26px);
    }
    .result-card {
      background: var(--surface);
      border-radius: 22px;
      border: 1px solid var(--border);
      box-shadow: 0 22px 44px rgba(15, 23, 42, 0.12);
      padding: clamp(24px, 3vw, 32px);
      display: grid;
      gap: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 16px;
      overflow: hidden;
    }
    thead {
      background: var(--surface-soft);
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      text-align: left;
      font-size: 14px;
    }
    th {
      font-weight: 600;
      color: var(--muted);
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status-present { color: #16a34a; }
    .status-late { color: #ca8a04; }
    .status-left-early { color: #f97316; }
    .status-break-missing { color: #f97316; }
    .status-partial { color: #eab308; }
    .status-absent { color: var(--danger); }
    .email-links a {
      display: inline-block;
      margin: 6px 8px 0 0;
      font-size: 13px;
      color: var(--primary);
      text-decoration: none;
    }
    .email-links a:hover {
      text-decoration: underline;
    }
    .notice {
      font-size: 14px;
      color: var(--muted);
    }
    .message {
      padding: 16px;
      border-radius: 14px;
      background: rgba(37, 99, 235, 0.08);
      border: 1px solid rgba(37, 99, 235, 0.18);
      color: var(--primary);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <span class="brand">Attendance Analysis Suite</span>
      <h1>Review attendance and prepare follow-up actions</h1>
      <p class="subhead">Select a date and session to inspect attendance across phases, identify follow-ups, and export tailored reports.</p>
    </header>

    <section class="controls" id="controls">
      <div>
        <h2 class="section-title">1. Select date</h2>
        <div class="date-grid" id="dateGrid"></div>
      </div>
      <div>
        <h2 class="section-title">2. Select session</h2>
        <div class="field-row">
          <label>Session ID
            <select id="sessionSelect">
              <option value="" disabled selected>Choose a date first</option>
            </select>
          </label>
          <button type="button" id="exportBtn" class="export-btn" disabled>Download session data</button>
        </div>
      </div>
      <div class="upload-box">
        <strong>Optional uploads</strong>
        <label>Replace attendance CSV
          <input id="attendanceUpload" type="file" accept=".csv">
        </label>
        <label>Roster CSV (one student ID per line)
          <input id="rosterUpload" type="file" accept=".csv">
        </label>
        <span class="notice">Without a roster, all unique students from the selected session are used as the roster.</span>
      </div>
    </section>

    <section class="results" id="results">
      <div class="message">Loading attendance data…</div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const dateGrid = document.getElementById('dateGrid');
    const sessionSelect = document.getElementById('sessionSelect');
    const resultsDiv = document.getElementById('results');
    const attendanceUpload = document.getElementById('attendanceUpload');
    const rosterUpload = document.getElementById('rosterUpload');
    const exportBtn = document.getElementById('exportBtn');

    const state = {
      records: [],
      byDate: new Map(),
      bySession: new Map(),
      sessionsByDate: new Map(),
      rosterSet: new Set(),
      selectedDate: null,
      selectedSession: null,
      lastRows: []
    };

    const statusOrder = ['Present', 'Late', 'Left Early', 'Break Missing', 'Partial', 'Absent'];

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length <= 1) return [];
      const header = lines[0].split(',').map(h => h.trim());
      const moduleIdx = header.findIndex(h => h.toLowerCase() === 'module');
      const groupIdx = header.findIndex(h => h.toLowerCase() === 'group');
      const records = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        const rec = {};
        header.forEach((h, idx) => {
          rec[h] = parts[idx] ? parts[idx].trim() : '';
        });
        if (moduleIdx !== -1) rec.module = parts[moduleIdx] ? parts[moduleIdx].trim() : '';
        if (groupIdx !== -1) rec.group = parts[groupIdx] ? parts[groupIdx].trim() : '';
        records.push(rec);
      }
      return records;
    }

    function sanitizeId(id) {
      return (id || '').replace(/[^0-9]/g, '').trim();
    }

    function extractDate(ts) {
      if (!ts) return '';
      const match = ts.match(/\d{4}-\d{2}-\d{2}/);
      if (match) return match[0];
      const date = new Date(ts);
      if (!isNaN(date)) return date.toISOString().slice(0, 10);
      return '';
    }

    function groupRecords(records) {
      state.byDate.clear();
      state.bySession.clear();
      state.sessionsByDate.clear();
      for (const rec of records) {
        const date = extractDate(rec.ts_utc);
        const sid = rec.sid;
        if (!date || !sid) continue;
        if (!state.byDate.has(date)) state.byDate.set(date, []);
        state.byDate.get(date).push(rec);
        if (!state.bySession.has(sid)) state.bySession.set(sid, []);
        state.bySession.get(sid).push(rec);
        if (!state.sessionsByDate.has(date)) state.sessionsByDate.set(date, new Set());
        state.sessionsByDate.get(date).add(sid);
      }
    }

    function renderDateChips() {
      dateGrid.innerHTML = '';
      if (!state.byDate.size) {
        dateGrid.textContent = 'No attendance dates available.';
        return;
      }
      const dates = Array.from(state.byDate.keys()).sort((a, b) => a.localeCompare(b));
      dates.forEach(date => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'date-chip';
        btn.textContent = new Date(date + 'T00:00:00Z').toLocaleDateString();
        btn.dataset.date = date;
        btn.addEventListener('click', () => {
          state.selectedDate = date;
          state.selectedSession = null;
          updateDateChipActive();
          populateSessions();
        });
        dateGrid.appendChild(btn);
      });
      if (!state.selectedDate) {
        state.selectedDate = dates[dates.length - 1];
      }
      updateDateChipActive();
    }

    function updateDateChipActive() {
      Array.from(dateGrid.querySelectorAll('.date-chip')).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.date === state.selectedDate);
      });
    }

    function populateSessions() {
      sessionSelect.innerHTML = '';
      const sessions = state.sessionsByDate.get(state.selectedDate);
      if (!sessions || sessions.size === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'No sessions for this date';
        opt.disabled = true;
        sessionSelect.appendChild(opt);
        state.selectedSession = null;
        state.lastRows = [];
        exportBtn.disabled = true;
        resultsDiv.innerHTML = '<div class="message">No attendance data for the selected date.</div>';
        return;
      }
      const sortedSessions = Array.from(sessions).sort();
      sortedSessions.forEach((sid, idx) => {
        const opt = document.createElement('option');
        opt.value = sid;
        const rec = state.bySession.get(sid)?.[0];
        if (rec && rec.module && rec.group) {
          opt.textContent = `${rec.module} — ${rec.group} (${sid})`;
        } else {
          opt.textContent = sid;
        }
        if (idx === 0 || sid === state.selectedSession) opt.selected = true;
        sessionSelect.appendChild(opt);
      });
      state.selectedSession = sessionSelect.value;
      renderResults();
    }

    function determineStatus(phases) {
      const hasStart = phases.has('start');
      const hasBreak = phases.has('break');
      const hasEnd = phases.has('end');
      if (hasStart && hasBreak && hasEnd) return 'Present';
      if (!hasStart && (hasBreak || hasEnd)) return 'Late';
      if (hasStart && !hasEnd) return 'Left Early';
      if (hasStart && hasEnd && !hasBreak) return 'Break Missing';
      if (hasStart || hasBreak || hasEnd) return 'Partial';
      return 'Absent';
    }

    function generateEmail(sid, sessionDate, status, phases) {
      const lb = '\r\n';
      const subject = `[Attendance Alert] ${sid} ${sessionDate}`;
      const body =
        `Dear Student,${lb}${lb}` +
        `Our records show that for session ${sid} on ${sessionDate}:${lb}` +
        `- Start: ${phases.has('start') ? 'Present' : 'Absent'}${lb}` +
        `- Break: ${phases.has('break') ? 'Present' : 'Absent'}${lb}` +
        `- End: ${phases.has('end') ? 'Present' : 'Absent'}${lb}${lb}` +
        `Please be aware that attendance is monitored and may affect your academic progress and visa compliance.${lb}${lb}` +
        `Regards,${lb}Ravensbourne University London${lb}`;
      return `Subject: ${subject}${lb}Content-Type: text/plain; charset=utf-8${lb}${lb}${body}`;
    }

    function renderResults() {
      resultsDiv.innerHTML = '';
      state.lastRows = [];
      if (!state.selectedDate || !state.selectedSession) {
        resultsDiv.innerHTML = '<div class="message">Select a date and session to view attendance.</div>';
        exportBtn.disabled = true;
        return;
      }
      const records = state.bySession.get(state.selectedSession) || [];
      const filtered = records.filter(rec => extractDate(rec.ts_utc) === state.selectedDate);
      if (!filtered.length) {
        resultsDiv.innerHTML = '<div class="message">No attendance records for the selected combination.</div>';
        exportBtn.disabled = true;
        return;
      }

      const phasesByStudent = new Map();
      filtered.forEach(rec => {
        const studentId = sanitizeId(rec.student_id);
        if (!studentId) return;
        if (!phasesByStudent.has(studentId)) phasesByStudent.set(studentId, new Set());
        phasesByStudent.get(studentId).add((rec.phase || '').toLowerCase());
      });

      const effectiveRoster = new Set(state.rosterSet.size ? state.rosterSet : phasesByStudent.keys());
      effectiveRoster.forEach(id => {
        if (!phasesByStudent.has(id)) phasesByStudent.set(id, new Set());
      });

      const rows = Array.from(phasesByStudent.entries()).map(([studentId, phases]) => {
        const startPhase = phases.has('start') ? 'Present' : 'Absent';
        const breakPhase = phases.has('break') ? 'Present' : 'Absent';
        const endPhase = phases.has('end') ? 'Present' : 'Absent';
        return {
          studentId,
          phases,
          startPhase,
          breakPhase,
          endPhase,
          status: determineStatus(phases)
        };
      });

      rows.sort((a, b) => {
        const statusDiff = statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
        if (statusDiff !== 0) return statusDiff;
        return a.studentId.localeCompare(b.studentId);
      });

      state.lastRows = rows;
      exportBtn.disabled = rows.length === 0;

      const sessionCard = document.createElement('div');
      sessionCard.className = 'result-card';

      const title = document.createElement('h2');
      title.textContent = `${state.selectedSession} — ${new Date(state.selectedDate + 'T00:00:00Z').toLocaleDateString()}`;
      sessionCard.appendChild(title);

      const table = document.createElement('table');
      table.innerHTML = '<thead><tr><th>Student ID</th><th>Start</th><th>Break</th><th>End</th><th>Status</th></tr></thead>';
      const tbody = document.createElement('tbody');

      const emailLinks = document.createElement('div');
      emailLinks.className = 'email-links';
      const sessionDate = state.selectedDate;

      rows.forEach(({ studentId, phases, startPhase, breakPhase, endPhase, status }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${studentId}</td>
          <td>${startPhase === 'Present' ? '✔' : '—'}</td>
          <td>${breakPhase === 'Present' ? '✔' : '—'}</td>
          <td>${endPhase === 'Present' ? '✔' : '—'}</td>
          <td class="status-${status.toLowerCase().replace(/\s/g, '-')}">${status}</td>
        `;
        tbody.appendChild(tr);
        if (status !== 'Present') {
          const eml = generateEmail(state.selectedSession, sessionDate, status, phases);
          const blob = new Blob([eml], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${studentId}_${state.selectedSession}_${status}.eml`;
          link.textContent = `Draft email for ${studentId} (${status})`;
          emailLinks.appendChild(link);
        }
      });

      table.appendChild(tbody);
      sessionCard.appendChild(table);

      if (emailLinks.children.length) {
        const secondaryTitle = document.createElement('div');
        secondaryTitle.textContent = 'Follow-up emails';
        secondaryTitle.style.fontWeight = '600';
        secondaryTitle.style.marginTop = '4px';
        sessionCard.appendChild(secondaryTitle);
        sessionCard.appendChild(emailLinks);
      }

      resultsDiv.appendChild(sessionCard);
    }

    function exportSessionToExcel() {
      if (!state.selectedSession || !state.lastRows.length || typeof XLSX === 'undefined') return;
      const rows = state.lastRows.map(row => ({
        'Student ID': row.studentId,
        'Start': row.startPhase,
        'Break': row.breakPhase,
        'End': row.endPhase,
        'Status': row.status
      }));
      const worksheet = XLSX.utils.json_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance');
      const filename = `${state.selectedSession}_${state.selectedDate}.xlsx`;
      XLSX.writeFile(workbook, filename);
    }

    async function loadAttendanceFromServer() {
      try {
        const resp = await fetch('/api/csv/current');
        if (!resp.ok) throw new Error('Attendance CSV not found on server.');
        const text = await resp.text();
        applyAttendanceData(text);
      } catch (err) {
        resultsDiv.innerHTML = `<div class="message">${err.message}</div>`;
      }
    }

    function applyAttendanceData(text) {
      const records = parseCSV(text);
      state.records = records;
      groupRecords(records);
      renderDateChips();
      populateSessions();
    }

    attendanceUpload.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const text = await file.text();
      applyAttendanceData(text);
    });

    rosterUpload.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) {
        state.rosterSet.clear();
        renderResults();
        return;
      }
      const text = await file.text();
      const lines = text.trim().split(/\r?\n/);
      state.rosterSet.clear();
      lines.forEach(line => {
        const id = sanitizeId(line);
        if (id) state.rosterSet.add(id);
      });
      renderResults();
    });

    sessionSelect.addEventListener('change', () => {
      state.selectedSession = sessionSelect.value;
      renderResults();
    });

    exportBtn.addEventListener('click', exportSessionToExcel);

    loadAttendanceFromServer();
  </script>
</body>
</html>