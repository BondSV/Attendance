<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Analysis</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f7f7f7;
      color: #333;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input[type="file"] {
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.6rem 1.2rem;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: default;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #e8e8e8;
    }
    .status-present {
      color: green;
    }
    .status-late, .status-left-early, .status-break-missing, .status-partial {
      color: orange;
    }
    .status-absent {
      color: red;
    }
    .section-title {
      font-size: 1.4rem;
      margin-top: 2rem;
    }
    .email-links {
      margin-top: 1rem;
    }
    .email-links a {
      display: block;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Attendance Analysis</h1>
  <div class="container">
    <p>Select one or more CSV log files generated by the Student/Collector app. Optionally, provide a roster (list of Student IDs) to include students with no entries.</p>
    <label for="logFiles">Attendance Log CSV files:</label>
    <input id="logFiles" type="file" accept=".csv" multiple>
    <label for="rosterFile">Roster CSV file (optional, one Student ID per line):</label>
    <input id="rosterFile" type="file" accept=".csv">
    <button id="analyzeBtn">Analyze Attendance</button>
  </div>
  <div id="results"></div>
  <script>
    // Simple CSV parser: splits by newlines and commas; assumes no commas in fields
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(',').map(h => h.trim());
      const records = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        const record = {};
        for (let j = 0; j < header.length; j++) {
          record[header[j]] = parts[j] ? parts[j].trim() : '';
        }
        records.push(record);
      }
      return records;
    }

    function sanitizeStudentId(id) {
      return id.replace(/[^0-9]/g, '').trim();
    }

    function determineStatus(phases) {
      const hasStart = phases.has('start');
      const hasBreak = phases.has('break');
      const hasEnd = phases.has('end');
      if (hasStart && hasBreak && hasEnd) return 'Present';
      if (!hasStart && (hasBreak || hasEnd)) return 'Late';
      if (hasStart && !hasEnd && (hasBreak || !hasBreak)) return 'Left Early';
      // Both start and end present but break missing
      if (hasStart && hasEnd && !hasBreak) return 'Break Missing';
      if (hasStart || hasBreak || hasEnd) return 'Partial';
      return 'Absent';
    }

    function generateEmail(sid, sessionDate, status, phases) {
      // Compose .eml content
      const lineBreak = '\r\n';
      const toAddress = '{{ID}}@rave.ac.uk';
      const subject = `[Attendance Alert] ${sid} ${sessionDate}`;
      // Format phases for message
      const startStatus = phases.has('start') ? 'Present' : 'Absent';
      const breakStatus = phases.has('break') ? 'Present' : 'Absent';
      const endStatus = phases.has('end') ? 'Present' : 'Absent';
      const body =
        `Dear Student,${lineBreak}${lineBreak}` +
        `Our records show that for session ${sid} on ${sessionDate}:${lineBreak}` +
        `- Start: ${startStatus}${lineBreak}` +
        `- Break: ${breakStatus}${lineBreak}` +
        `- End: ${endStatus}${lineBreak}${lineBreak}` +
        `Please be aware that attendance is monitored and may affect your academic progress and visa compliance.${lineBreak}${lineBreak}` +
        `Regards,${lineBreak}` +
        `Ravensbourne University London${lineBreak}`;
      const headers =
        `To: ${toAddress}${lineBreak}` +
        `Subject: ${subject}${lineBreak}` +
        `Content-Type: text/plain; charset=utf-8${lineBreak}` +
        `${lineBreak}`;
      return headers + body;
    }

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const logFiles = document.getElementById('logFiles').files;
      const rosterFile = document.getElementById('rosterFile').files[0];
      if (!logFiles.length) {
        alert('Please select at least one attendance log CSV file.');
        return;
      }
      const logs = [];
      // Read all log files
      for (const file of logFiles) {
        const text = await file.text();
        const records = parseCSV(text);
        logs.push(...records);
      }
      // Build roster set
      let rosterSet = new Set();
      if (rosterFile) {
        const text = await rosterFile.text();
        const lines = text.trim().split(/\r?\n/);
        for (const line of lines) {
          const id = sanitizeStudentId(line);
          if (id) rosterSet.add(id);
        }
      }
      // Aggregate attendance per session per student
      const sessionMap = new Map(); // sid -> Map(studentId -> Set(phases))
      for (const rec of logs) {
        const sid = rec.sid;
        const phase = rec.phase;
        const studentId = sanitizeStudentId(rec.student_id);
        if (!sid || !phase || !studentId) continue;
        if (!sessionMap.has(sid)) {
          sessionMap.set(sid, new Map());
        }
        const studentMap = sessionMap.get(sid);
        if (!studentMap.has(studentId)) {
          studentMap.set(studentId, new Set());
        }
        studentMap.get(studentId).add(phase.toLowerCase());
      }
      // Include roster students with no entries
      for (const sid of sessionMap.keys()) {
        const studentMap = sessionMap.get(sid);
        rosterSet.forEach(id => {
          if (!studentMap.has(id)) {
            studentMap.set(id, new Set());
          }
        });
      }
      // Build results HTML
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      if (sessionMap.size === 0) {
        resultsDiv.textContent = 'No records found.';
        return;
      }
      sessionMap.forEach((studentMap, sid) => {
        const sessionContainer = document.createElement('div');
        sessionContainer.className = 'container';
        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = `Session: ${sid}`;
        sessionContainer.appendChild(title);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Student ID</th><th>Start</th><th>Break</th><th>End</th><th>Status</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        // Determine session date string for email subject (extract from sid after last '-' as date). Use first part after module code
        let sessionDate = '';
        const parts = sid.split('-');
        if (parts.length >= 3) {
          // For example: OPS101-2025-10-03-0900 -> date may be parts[1], parts[2], parts[3]
          // We'll attempt to find YYYY-MM-DD in the sid by scanning for pattern \d{4}-\d{2}-\d{2}
          const match = sid.match(/\d{4}-\d{2}-\d{2}/);
          sessionDate = match ? match[0] : '';
        }
        // Generate per-student email links container
        const emailLinks = document.createElement('div');
        emailLinks.className = 'email-links';
        studentMap.forEach((phases, studentId) => {
          const status = determineStatus(phases);
          const tr = document.createElement('tr');
          const tdId = document.createElement('td');
          tdId.textContent = studentId;
          tr.appendChild(tdId);
          const tdStart = document.createElement('td');
          tdStart.textContent = phases.has('start') ? '✔' : '—';
          tr.appendChild(tdStart);
          const tdBreak = document.createElement('td');
          tdBreak.textContent = phases.has('break') ? '✔' : '—';
          tr.appendChild(tdBreak);
          const tdEnd = document.createElement('td');
          tdEnd.textContent = phases.has('end') ? '✔' : '—';
          tr.appendChild(tdEnd);
          const tdStatus = document.createElement('td');
          tdStatus.textContent = status;
          tdStatus.className = 'status-' + status.toLowerCase().replace(/\s/g, '-');
          tr.appendChild(tdStatus);
          tbody.appendChild(tr);
          // Compose email if not Present
          if (status !== 'Present') {
            const emlContent = generateEmail(sid, sessionDate, status, phases);
            const blob = new Blob([emlContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${studentId}_${sid}_${status}.eml`;
            link.textContent = `Email ${studentId} (${status})`;
            link.addEventListener('click', () => {
              // embed student ID into email on download
              // Not customizing To line here; replaced placeholder in eml file at download time is not trivial due to browser restrictions.
            });
            emailLinks.appendChild(link);
          }
        });
        table.appendChild(tbody);
        sessionContainer.appendChild(table);
        if (emailLinks.children.length > 0) {
          const emailTitle = document.createElement('div');
          emailTitle.style.marginTop = '1rem';
          emailTitle.textContent = 'Email drafts:';
          sessionContainer.appendChild(emailTitle);
          sessionContainer.appendChild(emailLinks);
        }
        resultsDiv.appendChild(sessionContainer);
      });
    });
  </script>
</body>
</html>