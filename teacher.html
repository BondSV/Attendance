<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Console</title>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-app);
    }

    /* Main Stage (Presentation Area) */
    .stage {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 40px;
    }

    .session-info {
      text-align: center;
      margin-bottom: 40px;
      animation: slideUp 0.6s var(--ease-out);
    }

    .module-code {
      font-size: 5rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      line-height: 1;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .phase-badge {
      display: inline-block;
      margin-top: 16px;
      padding: 8px 24px;
      border-radius: var(--radius-full);
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
      border: 1px solid rgba(59, 130, 246, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* QR Container */
    .qr-frame {
      background: #fff;
      padding: 32px;
      border-radius: 32px;
      box-shadow: 0 0 100px rgba(59, 130, 246, 0.15);
      animation: fadeIn 0.8s var(--ease-out);
      position: relative;
    }

    .qr-frame canvas {
      display: block;
    }

    .qr-placeholder {
      width: 400px;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      border: 2px dashed var(--bg-surface-hover);
      border-radius: 16px;
    }

    /* Live Counter */
    .live-counter {
      position: absolute;
      top: 40px;
      right: 40px;
      background: var(--bg-surface);
      padding: 12px 24px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
    }

    .live-counter.pulse {
      transform: scale(1.05);
      border-color: var(--success);
    }

    .counter-icon {
      font-size: 1.5rem;
    }

    .counter-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    /* Control Bar (Bottom) */
    .control-bar {
      background: var(--bg-surface);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 40px;
      display: flex;
      gap: 24px;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .control-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .input-dark {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-family: var(--font-mono);
      font-size: 1rem;
      width: 140px;
      text-align: center;
    }

    .input-dark:focus {
      outline: none;
      border-color: var(--primary);
    }

    select.input-dark {
      width: auto;
      cursor: pointer;
    }

    .divider {
      width: 1px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
    }

    /* Step 1 QR (Small, corner) */
    .session-qr-mini {
      position: absolute;
      bottom: 120px;
      left: 40px;
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .session-qr-mini:hover {
      opacity: 1;
    }

    .session-qr-mini canvas {
      width: 100px;
      height: 100px;
    }

    .session-qr-label {
      position: absolute;
      top: -25px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <!-- Live Counter -->
  <div class="live-counter" id="liveCounter" hidden>
    <span class="counter-icon">ðŸ‘¤</span>
    <span class="counter-value" id="counterValue">0</span>
    <span class="text-sm text-muted">Verified</span>
  </div>

  <!-- Main Stage -->
  <div class="stage">
    <div class="session-info">
      <div class="module-code" id="displayModule">READY</div>
      <div class="phase-badge" id="displayPhase">Setup</div>
    </div>

    <div class="qr-frame">
      <div id="verificationQr">
        <div class="qr-placeholder">
          <div class="text-center">
            <p class="font-bold mb-2">Start Session</p>
            <p class="text-sm text-muted">to generate verification code</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini Session QR (Bottom Left) -->
  <div class="session-qr-mini" id="sessionQr" hidden>
    <div class="session-qr-label">Join</div>
  </div>

  <!-- Controls -->
  <footer class="control-bar">
    <div class="control-group">
      <input type="text" id="moduleInput" class="input-dark" placeholder="MODULE" value="BSM24105">
      <input type="text" id="groupInput" class="input-dark" placeholder="GRP" value="1" style="width: 60px;">
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <select id="phaseSelect" class="input-dark">
        <option value="start">Start</option>
        <option value="break1">Break 1</option>
        <option value="break2">Break 2</option>
        <option value="end">End</option>
      </select>
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <button id="startBtn" class="btn btn-primary">Start Session</button>
      <button id="stopBtn" class="btn btn-ghost" disabled>Stop</button>
    </div>
  </footer>

  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    (() => {
      const DEFAULT_ORIGIN = window.location.origin;

      const elements = {
        moduleInput: document.getElementById('moduleInput'),
        groupInput: document.getElementById('groupInput'),
        phaseSelect: document.getElementById('phaseSelect'),
        startBtn: document.getElementById('startBtn'),
        stopBtn: document.getElementById('stopBtn'),
        displayModule: document.getElementById('displayModule'),
        displayPhase: document.getElementById('displayPhase'),
        verificationQr: document.getElementById('verificationQr'),
        sessionQr: document.getElementById('sessionQr'),
        liveCounter: document.getElementById('liveCounter'),
        counterValue: document.getElementById('counterValue')
      };

      let state = {
        active: false,
        sid: null,
        phase: null,
        timer: null,
        statsTimer: null,
        lastCount: 0
      };

      // --- Actions ---

      function startSession() {
        const module = elements.moduleInput.value.trim().toUpperCase();
        const group = elements.groupInput.value.trim();
        const phase = elements.phaseSelect.value;

        if (!module || !group) {
          alert('Please enter Module and Group');
          return;
        }

        state.active = true;
        state.sid = `${module} Group ${group}`;
        state.phase = phase;

        // Update UI
        elements.displayModule.textContent = module;
        elements.displayPhase.textContent = elements.phaseSelect.options[elements.phaseSelect.selectedIndex].text;
        elements.startBtn.disabled = true;
        elements.stopBtn.disabled = false;
        elements.moduleInput.disabled = true;
        elements.groupInput.disabled = true;
        elements.phaseSelect.disabled = true;

        elements.liveCounter.hidden = false;
        elements.sessionQr.hidden = false;

        // Generate Session QR (Static)
        const payload = { v: 1, sid: state.sid, p: phase, m: module, g: group };
        const url = `${DEFAULT_ORIGIN}/student#${btoa(JSON.stringify(payload)).replace(/\+/g, '-').replace(/\//g, '_')}`;
        renderQr(elements.sessionQr, url, 100);

        // Start Loops
        fetchChallenge();
        fetchStats();
        state.statsTimer = setInterval(fetchStats, 5000);
      }

      function stopSession() {
        state.active = false;
        clearTimeout(state.timer);
        clearInterval(state.statsTimer);

        elements.startBtn.disabled = false;
        elements.stopBtn.disabled = true;
        elements.moduleInput.disabled = false;
        elements.groupInput.disabled = false;
        elements.phaseSelect.disabled = false;

        elements.displayModule.textContent = 'PAUSED';
        elements.verificationQr.innerHTML = '<div class="qr-placeholder"><p class="text-muted">Session Paused</p></div>';
        elements.liveCounter.hidden = true;
      }

      // --- API Calls ---

      async function fetchChallenge() {
        if (!state.active) return;
        try {
          const res = await fetch(`/api/challenge?sid=${encodeURIComponent(state.sid)}&phase=${state.phase}`);
          const data = await res.json();

          renderQr(elements.verificationQr, data.challenge, 400);

          const ttl = data.ttl_ms || 3000;
          state.timer = setTimeout(fetchChallenge, Math.max(1000, ttl - 200));
        } catch (e) {
          console.error(e);
          state.timer = setTimeout(fetchChallenge, 2000);
        }
      }

      async function fetchStats() {
        if (!state.active) return;
        try {
          const res = await fetch(`/api/stats?sid=${encodeURIComponent(state.sid)}`);
          if (res.ok) {
            const data = await res.json();
            updateCounter(data.count || 0);
          }
        } catch (e) {
          console.warn('Stats failed', e);
        }
      }

      // --- Helpers ---

      function renderQr(el, text, size) {
        el.innerHTML = '';
        new QRCode(el, {
          text: text,
          width: size,
          height: size,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.L
        });
      }

      function updateCounter(count) {
        if (count !== state.lastCount) {
          elements.counterValue.textContent = count;
          elements.liveCounter.classList.remove('pulse');
          void elements.liveCounter.offsetWidth; // trigger reflow
          elements.liveCounter.classList.add('pulse');
          state.lastCount = count;
        }
      }

      // --- Events ---
      elements.startBtn.addEventListener('click', startSession);
      elements.stopBtn.addEventListener('click', stopSession);

    })();
  </script>
</body>

</html>