<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Console</title>
  <link rel="stylesheet" href="/design-system.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-app);
      /* Richer background for large screen */
      background-image:
        radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15), transparent 40%);
    }

    /* Header Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background: rgba(3, 7, 18, 0.5);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 50;
    }

    .session-title {
      display: flex;
      align-items: baseline;
      gap: 16px;
    }

    .module-display {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.03em;
    }

    .phase-badge {
      padding: 6px 16px;
      border-radius: var(--radius-full);
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      font-weight: 700;
      font-size: 1rem;
      border: 1px solid rgba(59, 130, 246, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .live-counter {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 24px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: var(--radius-full);
      color: var(--success);
      transition: all 0.3s;
    }

    .live-counter.pulse {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
      transform: scale(1.05);
    }

    /* Main Content - Split View */
    .main-stage {
      flex: 1;
      display: flex;
      padding: 40px;
      gap: 40px;
      align-items: stretch;
    }

    .col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .qr-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      position: relative;
    }

    .qr-label {
      position: absolute;
      top: 30px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .qr-wrapper {
      background: #fff;
      padding: 24px;
      border-radius: 24px;
      box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
    }

    .qr-wrapper canvas {
      display: block;
    }

    /* Control Bar */
    .control-bar {
      background: rgba(3, 7, 18, 0.8);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 24px 40px;
      display: flex;
      gap: 32px;
      align-items: center;
      justify-content: center;
    }

    .control-group {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .divider {
      width: 1px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
    }

    /* Utilities */
    .placeholder-text {
      color: var(--text-muted);
      font-size: 1.5rem;
      font-weight: 500;
    }
  </style>
</head>

<body>

  <header class="top-bar">
    <div class="session-title">
      <div class="module-display" id="displayModule">READY</div>
      <div class="phase-badge" id="displayPhase">Setup</div>
    </div>

    <div class="live-counter" id="liveCounter" hidden>
      <span style="font-size: 1.5rem">ðŸ‘¤</span>
      <span class="font-mono font-bold text-2xl" id="counterValue">0</span>
      <span class="uppercase text-sm font-bold" style="letter-spacing: 0.05em">Verified</span>
    </div>
  </header>

  <main class="main-stage">
    <!-- Column 1: Join (Static) -->
    <div class="col">
      <div class="glass-card qr-card">
        <div class="qr-label">Step 1: Join</div>
        <div class="qr-wrapper" id="sessionQrWrapper" hidden>
          <div id="sessionQr"></div>
        </div>
        <div class="placeholder-text" id="sessionPlaceholder">
          Enter details to start
        </div>
      </div>
    </div>

    <!-- Column 2: Verify (Dynamic) -->
    <div class="col">
      <div class="glass-card qr-card"
        style="background: linear-gradient(145deg, rgba(59, 130, 246, 0.1) 0%, rgba(3, 7, 18, 0.4) 100%); border-color: rgba(59, 130, 246, 0.2);">
        <div class="qr-label" style="color: #60a5fa;">Step 2: Verify</div>
        <div class="qr-wrapper" id="verificationQrWrapper" hidden>
          <div id="verificationQr"></div>
        </div>
        <div class="placeholder-text" id="verificationPlaceholder">
          Waiting for session...
        </div>
      </div>
    </div>
  </main>

  <footer class="control-bar">
    <div class="control-group">
      <input type="text" id="moduleInput" class="input-glass" placeholder="MODULE" value="BSM24105"
        style="width: 160px; text-align: center; font-size: 1.25rem; font-weight: 700;">
      <input type="text" id="groupInput" class="input-glass" placeholder="GRP" value="1"
        style="width: 80px; text-align: center; font-size: 1.25rem;">
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <select id="phaseSelect" class="input-glass" style="font-size: 1.1rem; cursor: pointer;">
        <option value="start">Start</option>
        <option value="break1">Break 1</option>
        <option value="break2">Break 2</option>
        <option value="end">End</option>
      </select>
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <button id="startBtn" class="btn btn-primary" style="font-size: 1.1rem; padding: 16px 32px;">Start
        Session</button>
      <button id="stopBtn" class="btn btn-ghost" disabled>Stop</button>
    </div>
  </footer>

  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    (() => {
      const DEFAULT_ORIGIN = window.location.origin;

      const elements = {
        moduleInput: document.getElementById('moduleInput'),
        groupInput: document.getElementById('groupInput'),
        phaseSelect: document.getElementById('phaseSelect'),
        startBtn: document.getElementById('startBtn'),
        stopBtn: document.getElementById('stopBtn'),
        displayModule: document.getElementById('displayModule'),
        displayPhase: document.getElementById('displayPhase'),

        sessionQr: document.getElementById('sessionQr'),
        sessionQrWrapper: document.getElementById('sessionQrWrapper'),
        sessionPlaceholder: document.getElementById('sessionPlaceholder'),

        verificationQr: document.getElementById('verificationQr'),
        verificationQrWrapper: document.getElementById('verificationQrWrapper'),
        verificationPlaceholder: document.getElementById('verificationPlaceholder'),

        liveCounter: document.getElementById('liveCounter'),
        counterValue: document.getElementById('counterValue')
      };

      let state = {
        active: false,
        sid: null,
        phase: null,
        timer: null,
        statsTimer: null,
        lastCount: 0
      };

      // --- Actions ---

      function startSession() {
        const module = elements.moduleInput.value.trim().toUpperCase();
        const group = elements.groupInput.value.trim();
        const phase = elements.phaseSelect.value;

        if (!module || !group) {
          alert('Please enter Module and Group');
          return;
        }

        state.active = true;
        state.sid = `${module} Group ${group}`;
        state.phase = phase;

        // Update UI
        elements.displayModule.textContent = module;
        elements.displayPhase.textContent = elements.phaseSelect.options[elements.phaseSelect.selectedIndex].text;

        elements.startBtn.disabled = true;
        elements.stopBtn.disabled = false;
        elements.moduleInput.disabled = true;
        elements.groupInput.disabled = true;
        elements.phaseSelect.disabled = true;

        elements.liveCounter.hidden = false;

        // Show QR Containers
        elements.sessionPlaceholder.hidden = true;
        elements.sessionQrWrapper.hidden = false;
        elements.verificationPlaceholder.hidden = true;
        elements.verificationQrWrapper.hidden = false;

        // Generate Session QR (Static) - Large Size
        const payload = { v: 1, sid: state.sid, p: phase, m: module, g: group };
        const url = `${DEFAULT_ORIGIN}/student#${btoa(JSON.stringify(payload)).replace(/\+/g, '-').replace(/\//g, '_')}`;
        renderQr(elements.sessionQr, url, 350); // Increased size

        // Start Loops
        fetchChallenge();
        fetchStats();
        state.statsTimer = setInterval(fetchStats, 5000);
      }

      function stopSession() {
        state.active = false;
        clearTimeout(state.timer);
        clearInterval(state.statsTimer);

        elements.startBtn.disabled = false;
        elements.stopBtn.disabled = true;
        elements.moduleInput.disabled = false;
        elements.groupInput.disabled = false;
        elements.phaseSelect.disabled = false;

        elements.displayModule.textContent = 'PAUSED';

        // Hide QRs
        elements.sessionQrWrapper.hidden = true;
        elements.sessionPlaceholder.hidden = false;
        elements.verificationQrWrapper.hidden = true;
        elements.verificationPlaceholder.hidden = false;
        elements.verificationPlaceholder.textContent = 'Session Paused';

        elements.liveCounter.hidden = true;
      }

      // --- API Calls ---

      async function fetchChallenge() {
        if (!state.active) return;
        try {
          const res = await fetch(`/api/challenge?sid=${encodeURIComponent(state.sid)}&phase=${state.phase}`);
          const data = await res.json();

          renderQr(elements.verificationQr, data.challenge, 450); // Massive size

          const ttl = data.ttl_ms || 3000;
          state.timer = setTimeout(fetchChallenge, Math.max(1000, ttl - 200));
        } catch (e) {
          console.error(e);
          state.timer = setTimeout(fetchChallenge, 2000);
        }
      }

      async function fetchStats() {
        if (!state.active) return;
        try {
          const res = await fetch(`/api/stats?sid=${encodeURIComponent(state.sid)}`);
          if (res.ok) {
            const data = await res.json();
            updateCounter(data.count || 0);
          }
        } catch (e) {
          console.warn('Stats failed', e);
        }
      }

      // --- Helpers ---

      function renderQr(el, text, size) {
        el.innerHTML = '';
        new QRCode(el, {
          text: text,
          width: size,
          height: size,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.L
        });
      }

      function updateCounter(count) {
        if (count !== state.lastCount) {
          elements.counterValue.textContent = count;
          elements.liveCounter.classList.remove('pulse');
          void elements.liveCounter.offsetWidth; // trigger reflow
          elements.liveCounter.classList.add('pulse');
          state.lastCount = count;
        }
      }

      // --- Events ---
      elements.startBtn.addEventListener('click', startSession);
      elements.stopBtn.addEventListener('click', stopSession);

    })();
  </script>
</body>

</html>