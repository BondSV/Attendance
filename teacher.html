<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Attendance QR</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f9f9f9;
      color: #222;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input[type="text"], select {
      padding: 0.4rem 0.5rem;
      margin-top: 0.2rem;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    #display {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1.5rem;
      gap: 1.5rem;
    }
    #bearCanvas {
      border: 1px solid #ccc;
      background: #000;
      max-width: 100%;
    }
    #qrContainer {
      border: 1px solid #ccc;
      padding: 0.5rem;
      background: #fff;
    }
  </style>
</head>
<body>
  <h1>Attendance Session QR Generator</h1>
  <p>Enter session details and start the checkâ€‘in window. The animated bear will indicate a live signal for students to scan. A single QR code links students to the attendance page with the required parameters.</p>

  <label for="sessionId">Session ID</label>
  <input id="sessionId" type="text" placeholder="e.g., OPS101-2025-10-03-0900" />

  <label for="studentOrigin">Student App Origin (default current origin)</label>
  <input id="studentOrigin" type="text" placeholder="https://attendance.uni.ac.uk" />

  <label for="phase">Phase</label>
  <select id="phase">
    <option value="start">Start</option>
    <option value="break">Break</option>
    <option value="end">End</option>
  </select>

  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>

  <div id="display" style="display:none;">
    <canvas id="bearCanvas" width="360" height="220"></canvas>
    <div id="qrContainer"></div>
  </div>

  <!-- QRCode library from CDN; fallback to available cached library. -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
  const CHAR_PATTERNS = {
    '0': [1,1,1, 1,0,1, 1,0,1, 1,0,1, 1,1,1],
    '1': [0,1,0, 1,1,0, 0,1,0, 0,1,0, 1,1,1],
    '2': [1,1,1, 0,0,1, 1,1,1, 1,0,0, 1,1,1],
    '3': [1,1,1, 0,0,1, 1,1,1, 0,0,1, 1,1,1],
    '4': [1,0,1, 1,0,1, 1,1,1, 0,0,1, 0,0,1],
    '5': [1,1,1, 1,0,0, 1,1,1, 0,0,1, 1,1,1],
    '6': [1,1,1, 1,0,0, 1,1,1, 1,0,1, 1,1,1],
    '7': [1,1,1, 0,0,1, 0,1,0, 1,0,0, 1,0,0],
    '8': [1,1,1, 1,0,1, 1,1,1, 1,0,1, 1,1,1],
    '9': [1,1,1, 1,0,1, 1,1,1, 0,0,1, 1,1,1],
    ':': [0,0,0, 0,1,0, 0,0,0, 0,1,0, 0,0,0],
  };

  function toBase64Url(obj) {
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }

  let running = false;
  let offset = 0;
  let resyncIntervalId;

  let salt = { value: 0, expiresAt: 0, rotationMs: 600, acceptWindowMs: 1000 };

  const canvas = document.getElementById('bearCanvas');
  const ctx = canvas.getContext('2d');
  const qrContainer = document.getElementById('qrContainer');
  const displayDiv = document.getElementById('display');

  function drawChar(char, x, y, cell, colorOn = '#ffffff', colorOff = '#111111') {
    const pattern = CHAR_PATTERNS[char];
    if (!pattern) return;
    const cols = 3;
    const rows = 5;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const v = pattern[r * cols + c];
        ctx.fillStyle = v ? colorOn : colorOff;
        ctx.fillRect(x + c * cell, y + r * cell, cell, cell);
      }
    }
  }

  function drawDisplay(text) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const cell = Math.floor(Math.min(canvas.width, canvas.height) / 10);
    const charWidth = cell * 3;
    const charGap = cell;
    const totalWidth = text.length * charWidth + (text.length - 1) * charGap;
    const startX = Math.floor((canvas.width - totalWidth) / 2);
    const startY = Math.floor((canvas.height - cell * 5) / 2);

    ctx.shadowBlur = 30;
    ctx.shadowColor = '#00eaff';
    ctx.fillStyle = '#00eaff';
    const glowMargin = cell;
    ctx.fillRect(startX - glowMargin, startY - glowMargin, totalWidth + glowMargin * 2, cell * 5 + glowMargin * 2);
    ctx.shadowBlur = 0;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const x = startX + i * (charWidth + charGap);
      drawChar(ch, x, startY, cell);
    }
  }

  async function resync() {
    try {
      const resp = await fetch('/api/time');
      const data = await resp.json();
      offset = data.now_ms - Date.now();
      salt = {
        value: data.salt,
        expiresAt: data.salt_expires_ms,
        rotationMs: data.rotation_ms,
        acceptWindowMs: data.accept_window_ms,
      };
    } catch (err) {
      console.error('Time sync failed', err);
    }
  }

  function currentCode() {
    const now = Date.now() + offset;
    const date = new Date(now);
    const mm = String(date.getUTCMinutes()).padStart(2, '0');
    const ss = String(date.getUTCSeconds()).padStart(2, '0');
    const saltDigits = String(Math.abs(salt.value || 0) % 100).padStart(2, '0');
    return `${mm}:${ss}:${saltDigits}`;
  }

  function animate() {
    if (!running) return;
    drawDisplay(currentCode());
    requestAnimationFrame(animate);
  }

  document.getElementById('startBtn').addEventListener('click', async () => {
    const sid = document.getElementById('sessionId').value.trim();
    const phase = document.getElementById('phase').value;
    const studentOriginInput = document.getElementById('studentOrigin').value.trim();
    const studentOrigin = studentOriginInput || window.location.origin;
    if (!sid) {
      alert('Please enter a session ID.');
      return;
    }
    await resync();
    const payload = { v: 1, sid: sid, p: phase };
    const frag = toBase64Url(payload);
    const url = `${studentOrigin.replace(/\/$/, '')}/student#${frag}`;
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, { text: url, width: 200, height: 200 });
    displayDiv.style.display = 'flex';
    running = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    animate();
    if (resyncIntervalId) clearInterval(resyncIntervalId);
    resyncIntervalId = setInterval(resync, 20000);
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    running = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    displayDiv.style.display = 'none';
    qrContainer.innerHTML = '';
    if (resyncIntervalId) clearInterval(resyncIntervalId);
  });
  </script>
</body>
</html>